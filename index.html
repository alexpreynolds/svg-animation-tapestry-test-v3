<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Altius Insitute for Biomedical Sciences</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="assets/css/styles.css" media="screen">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <!-- cf. http://www.favicomatic.com -->
        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="assets/favico/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/favico/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/favico/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/favico/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="assets/favico/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="assets/favico/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="assets/favico/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="assets/favico/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="&nbsp;"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="assets/favico/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="assets/favico/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="assets/favico/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="assets/favico/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="assets/favico/mstile-310x310.png" />
    </head>
    <body>
        <div id="parent_container">
            <div id="svg_container">
                <div id="node_layers_container"></div>
                <div id="wordmark_container"></div>
            </div>
            <div id="content" style="opacity:0;">
                <div id="animation_settings">
                    <form class='settings_form'>
                        <label>Actions: </label>
                        <button type="button" name="action_reset_node_layers" id="action_reset_node_layers">Reset</button> 
                        <button type="button" name="action_pause_animation" id="action_pause_animation">Pause</button>
                        <br />
                        <label>Animation type: </label>
                        <select id="animation_type_select">
                            <option value="scroll_right">Tesselation</option>
                            <option value="scroll_right_zipper">Tesselation with zipper effect</option>
                            <option value="scroll_right_zipper_with_rotation">Tesselation with zipper effect (+rotation)</option>
                            <option value="scroll_right_zipper_with_rotation_with_velocity_jitter">Tesselation with zipper effect (+rotation, +velocityJitter)</option>
                            <option value="scroll_right_zipper_with_rotation_with_rotation_jitter">Tesselation with zipper effect (+rotation, +rotationJitter)</option>
                            <option value="scroll_right_zipper_with_rotation_with_velocity_and_rotation_jitter">Tesselation with zipper effect (+rotation, +velocityJitter, +rotationJitter)</option>
                        </select>
                        <br />
                        <label>Rows: </label>
                        <select id="rows_count_select">
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                        </select>
                        <br />
                        <label>X-axis velocity: </label>
                        <select id="x_velocity_select">
                            <option value="0.50">0.50</option>
                            <option value="0.75">0.75</option>
                            <option value="1.00">1.00</option>
                            <option value="1.25">1.25</option>
                            <option value="1.50">1.50</option>
                            <option value="1.75">1.75</option>
                            <option value="2.00">2.00</option>
                        </select>
                        <br />
                        <label>X-axis velocity, increment: </label>
                        <select id="x_velocity_increment_select">
                            <option value="0.005">0.005</option>
                            <option value="0.010">0.010</option>
                            <option value="0.015">0.015</option>
                            <option value="0.020">0.020</option>
                            <option value="0.025">0.025</option>
                            <option value="0.030">0.030</option>
                        </select>
                        <br />
                        <label>Y-axis velocity: </label>
                        <select id="y_velocity_select">
                            <option value="0.00">0.00</option>
                        </select>
                        <br />
                        <label>Y-axis velocity, increment: </label>
                        <select id="y_velocity_increment_select">
                            <option value="0.0025">0.0025</option>
                            <option value="0.005">0.005</option>
                            <option value="0.010">0.010</option>
                            <option value="0.015">0.015</option>
                            <option value="0.020">0.020</option>
                            <option value="0.025">0.025</option>
                            <option value="0.030">0.030</option>
                        </select>
                        <br />
                        <label>Rotation, initial: </label>
                        <select id="rotation_initial_select">
                            <option value="0.00">0.00</option>
                        </select>
                        <br />
                        <label>Rotation, increment: </label>
                        <select id="rotation_increment_select">
                            <option value="0.25">0.25</option>
                            <option value="0.50">0.50</option>
                            <option value="0.75">0.75</option>
                            <option value="1.00">1.00</option>
                        </select>
                    </form>
                </div>
                <div class="main">
                    <p>Developing revolutionary technologies to empower breakthrough science</p>
                    <p>Creating a new scientific environment that radically enables exceptionally talented individuals to do the best work of their lives</p>
                </div>
                <div class="contact">
                    <p>
                        Inquiries: <a href="mailto:info@altiusinstitute.org">info@altiusinstitute.org</a><br>
                        2211 Elliott Ave, Suite 600, Seattle WA 98121
                    </p>
                </div>
            </div>
            <div id="background"><img src="assets/img/background.jpg" alt="Altius Institute for Biomedical Sciences" id="logo_background" class="logo_background" /></div>
        </div>
        
        <!-- cf. https://github.com/petkaantonov/deque -->
        <script type="text/javascript" src="assets/js/deque.min.js"></script>
        <script type="text/javascript" src="assets/js/guid.min.js"></script>

        <!-- external frameworks -->
        <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="https://d3js.org/d3-timer.v1.min.js"></script>
        
        <!-- my code -->
        <script type="text/javascript">

            var Animation = Animation || {};

            Animation.SVG_ASSET_ROOT = "assets/components/";

            Animation.WORDMARK_SCALE = 1.85; // a higher value makes a smaller wordmark
            Animation.WORDMARK_EASE_FN = "cubic";
            Animation.WORDMARK_EASE_DURATION_MS = 750;
            Animation.WORDMARK_FINAL_OPACITY = 1;

            Animation.CONTENT_EASE_FN = "cubic";
            Animation.CONTENT_EASE_DURATION_MS = 750;
            Animation.CONTENT_FINAL_OPACITY = 1;
            Animation.CONTENT_TOP_PADDING = 20;

            Animation.NODE_LAYERS = 14;
            Animation.NODE_LAYER_DEFAULT_ROWS = 12;
            Animation.NODE_LAYER_ID_PREFIX = "node_layer_";
            Animation.NODE_LAYER_SCALE = 1.7;
            Animation.NODE_LAYER_SLOWDOWN_FACTOR = 0.5;
            Animation.NODE_ROW_SQUEEZE_FACTOR = 1;
            Animation.NODE_COL_SQUEEZE_FACTOR = 1;
            Animation.NODE_LAYERS_EASE_FN = "cubic";
            Animation.NODE_LAYERS_EASE_DURATION_MS = 1000;
            Animation.NODE_LAYERS_FINAL_OPACITY = 1;
            Animation.NODE_LAYER_CENTER_X = 114;
            Animation.NODE_LAYER_CENTER_Y = 109;
            Animation.NODE_LAYER_DEFAULT_ROW_EVAPORATION_FACTOR = 0.05;

            Animation.ANIMATION_INITIAL_VELOCITY_X = "1.50";
            Animation.ANIMATION_INITIAL_VELOCITY_Y = "0.00";
            Animation.ANIMATION_INCREMENT_VELOCITY_X = "0.020";
            Animation.ANIMATION_INCREMENT_VELOCITY_Y = "0.005";
            Animation.ANIMATION_INITIAL_ROTATION = "0.00";
            Animation.ANIMATION_INCREMENT_ROTATION = "1.00";
            Animation.ANIMATION_EASE_FN = "linear";
            Animation.ANIMATION_DURATION_MS = 0;

            Animation.AnimationTypes = {
                SCROLL_RIGHT : "scroll_right",
                SCROLL_RIGHT_ZIPPER : "scroll_right_zipper",
                SCROLL_RIGHT_ZIPPER_WITH_ROTATION : "scroll_right_zipper_with_rotation",
                SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_JITTER : "scroll_right_zipper_with_rotation_with_velocity_jitter",
                SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_ROTATION_JITTER : "scroll_right_zipper_with_rotation_with_rotation_jitter",
                SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_AND_ROTATION_JITTER : "scroll_right_zipper_with_rotation_with_velocity_and_rotation_jitter",
            };
            Animation.ANIMATION_DEFAULT_TYPE = Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_AND_ROTATION_JITTER;

            Animation.animation_type = Animation.ANIMATION_DEFAULT_TYPE;
            Animation.animation_is_setup = false;
            Animation.animation_timer_on_hold = false;
            Animation.animation_verbose = false;
            Animation.all_node_layers_offscreen = true;

            Animation.svg_parent = document.getElementById('svg_container');
            Animation.wordmark_parent = document.getElementById('wordmark_container');
            Animation.node_layers_parent = document.getElementById('node_layers_container');

            Animation.logo_background_img = document.getElementById('logo_background');
            Animation.logo_background = { offset : null, width : 0, height : 0, centerX : 0, centerY : 0 };

            Animation.node_layers_xml = null;
            Animation.node_layers_deque = new Deque();
            Animation.node_layers_ids = [];
            Animation.node_layers_animating = new Deque();
            Animation.node_layers_all_visible = false;
            Animation.node_layer_margin = { top : 0, right : 0, bottom : 0, left : 0 };
            Animation.node_layers = { max_height : 0, max_width : 0, rows : 0, cols : 0 };
            Animation.node_layer_rotation_degrees = 0;
            Animation.node_layer_rows = Animation.NODE_LAYER_DEFAULT_ROWS + 1;
            Animation.node_layers_loaded = false;
            Animation.node_layer_current_leftmost_objs = [];
            Animation.node_layer_x_velocity_initial = parseFloat(Animation.ANIMATION_INITIAL_VELOCITY_X);
            Animation.node_layer_x_velocity_increment = parseFloat(Animation.ANIMATION_INCREMENT_VELOCITY_X);
            Animation.node_layer_y_velocity_initial = parseFloat(Animation.ANIMATION_INITIAL_VELOCITY_Y);
            Animation.node_layer_y_velocity_increment = parseFloat(Animation.ANIMATION_INCREMENT_VELOCITY_Y);
            Animation.node_layer_rotation_initial = parseFloat(Animation.ANIMATION_INITIAL_ROTATION);
            Animation.node_layer_rotation_increment = parseFloat(Animation.ANIMATION_INCREMENT_ROTATION);

            Animation.rows_count_select = document.getElementById("rows_count_select");
            Animation.rows_count_select.value = Animation.NODE_LAYER_DEFAULT_ROWS;
            Animation.animation_type_select = document.getElementById("animation_type_select");
            Animation.animation_type_select.value = Animation.ANIMATION_DEFAULT_TYPE;
            Animation.x_velocity_select = document.getElementById("x_velocity_select");
            Animation.x_velocity_select.value = Animation.ANIMATION_INITIAL_VELOCITY_X;
            Animation.x_velocity_increment_select = document.getElementById("x_velocity_increment_select");
            Animation.x_velocity_increment_select.value = Animation.ANIMATION_INCREMENT_VELOCITY_X;
            Animation.y_velocity_select = document.getElementById("y_velocity_select");
            Animation.y_velocity_select.value = Animation.ANIMATION_INITIAL_VELOCITY_Y;
            Animation.y_velocity_increment_select = document.getElementById("y_velocity_increment_select");
            Animation.y_velocity_increment_select.value = Animation.ANIMATION_INCREMENT_VELOCITY_Y;
            Animation.rotation_initial_select = document.getElementById("rotation_initial_select");
            Animation.rotation_initial_select.value = Animation.ANIMATION_INITIAL_ROTATION;
            Animation.rotation_increment_select = document.getElementById("rotation_increment_select");
            Animation.rotation_increment_select.value = Animation.ANIMATION_INCREMENT_ROTATION;

            Animation.rows_count_select.addEventListener("change", function() { 
                Animation.node_layer_rows = Animation.rows_count_select.value;
                Animation.reset_node_layers(false);
            });
            Animation.animation_type_select.addEventListener("change", function() { 
                Animation.animation_type = Animation.animation_type_select.value;
                Animation.reset_node_layers(false);
            });
            Animation.x_velocity_select.addEventListener("change", function() { 
                Animation.node_layer_x_velocity_initial = parseFloat(Animation.x_velocity_select.value);
                Animation.reset_node_layers(false);
            });
            Animation.x_velocity_increment_select.addEventListener("change", function() { 
                Animation.node_layer_x_velocity_increment = parseFloat(Animation.x_velocity_increment_select.value);
                Animation.reset_node_layers(false);
            });
            Animation.y_velocity_select.addEventListener("change", function() { 
                Animation.node_layer_y_velocity_initial = parseFloat(Animation.y_velocity_select.value);
                Animation.reset_node_layers(false);
            });
            Animation.y_velocity_increment_select.addEventListener("change", function() { 
                Animation.node_layer_y_velocity_increment = parseFloat(Animation.y_velocity_increment_select.value);
                Animation.reset_node_layers(false);
            });
            Animation.rotation_initial_select.addEventListener("change", function() { 
                Animation.node_layer_rotation_initial = parseFloat(Animation.rotation_initial_select.value);
                Animation.reset_node_layers(false);
            });
            Animation.rotation_increment_select.addEventListener("change", function() { 
                Animation.node_layer_rotation_increment = parseFloat(Animation.rotation_increment_select.value);
                Animation.reset_node_layers(false);
            });

            Animation.tick_count = 0;

            d3.timer(function() { 
                if (!Animation.animation_timer_on_hold) Animation.tick(Animation.animation_verbose);
                return Animation.animation_timer_on_hold; 
            });

            Animation.tick = function(verbose) {
                if (verbose) console.log("tick");
                //
                // if Animation.node_layers_loaded is true, we update all node layer 
                // properties, depending on the animation type; these properties can
                // specify rotation, on-screen xy position, opacity, etc.
                //
                if (Animation.node_layers_loaded && !Animation.node_layers_deque.isEmpty()) {
                    if (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT) {
                        var velocity_jitter = false;
                        if (!Animation.animation_is_setup) {
                            Animation.setup_scroll_right(verbose, velocity_jitter, function() { Animation.animation_is_setup = true; });
                            if (verbose) console.log(Animation.node_layers_animating);
                        }
                        else {
                            Animation.update_scroll_right(verbose, null);
                        }
                    }
                    else if (
                        (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER) || 
                        (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION) ||
                        (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_JITTER) ||
                        (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_ROTATION_JITTER) ||
                        (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_AND_ROTATION_JITTER)
                        ) 
                    {
                        var rotate = (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER) ? false : true;
                        var velocity_jitter = (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_JITTER) ? true : false;
                        var rotation_jitter = (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_ROTATION_JITTER) ? true : false;
                        if (Animation.animation_type == Animation.AnimationTypes.SCROLL_RIGHT_ZIPPER_WITH_ROTATION_WITH_VELOCITY_AND_ROTATION_JITTER) {
                            velocity_jitter = true;
                            rotation_jitter = true;
                        }
                        if (!Animation.animation_is_setup) {
                            Animation.setup_scroll_right(verbose, velocity_jitter, rotation_jitter, function() { 
                                Animation.animation_is_setup = true; 
                            });
                            if (verbose) console.log(Animation.node_layers_animating);
                        }
                        else {
                            Animation.update_scroll_right_zipper(verbose, rotate, null);
                        }
                    }
                }

                if (Animation.node_layers_loaded && Animation.all_node_layers_offscreen) {
                    Animation.reset_node_layers(verbose);
                }

                Animation.tick_count++;
            };

            Animation.setup_scroll_right = function(verbose, velocity_jitter, rotation_jitter, cb) {
                // go through all node layer objects and set their is_static, 
                // is_offscreen and animating properties
                for (var row_idx = 0; row_idx < Animation.node_layers.rows; row_idx++) {
                    for (var col_idx = 0; col_idx < Animation.node_layers.cols; col_idx++) {
                        node_layer_obj = Animation.get_node_layer_obj(row_idx, col_idx);
                        try {
                            var layer_id = node_layer_obj['id'];
                            var is_static = node_layer_obj['static'];
                            var is_offscreen = Animation.is_node_layer_offscreen(
                                node_layer_obj['top'],
                                node_layer_obj['left'],
                                node_layer_obj['width'],
                                node_layer_obj['height'],
                                Animation.logo_background.width,
                                Animation.logo_background.height
                            );
                            if (!is_offscreen && is_static) {
                                node_layer_obj['static'] = false;
                                Animation.node_layers_animating.push({'row' : row_idx, 'col' : col_idx});
                                node_layer_obj['velocity_x'] = Animation.node_layer_x_velocity_initial;
                                node_layer_obj['velocity_y'] = Animation.node_layer_y_velocity_initial;
                                node_layer_obj['rotation'] = Animation.node_layer_rotation_initial;
                                if (velocity_jitter) {
                                    var x_velocity_increment_jitter = get_random_float_exclusive(0.0, node_layer_obj['velocity_x_increment'] / 2);
                                    node_layer_obj['velocity_x_increment'] += x_velocity_increment_jitter;
                                    var y_velocity_increment_jitter = get_random_float_exclusive(0.0, node_layer_obj['velocity_y_increment'] / 2);
                                    node_layer_obj['velocity_y_increment'] -= y_velocity_increment_jitter;
                                }
                                if (rotation_jitter) {
                                    var rotation_increment_jitter = get_random_float_exclusive(0.0, node_layer_obj['rotation_increment'] / 2);
                                    node_layer_obj['rotation_increment'] -= rotation_increment_jitter;
                                }
                            }
                            else {
                                if (verbose) console.log("offscreen", {'row' : row_idx, 'col' : col_idx, 'obj' : node_layer_obj});
                            }
                        }
                        catch (err) {
                            Animation.animation_timer_on_hold = true;
                        }
                    }
                }
                Animation.all_node_layers_offscreen = false;
                if (cb) cb();
            };

            Animation.update_scroll_right = function(verbose, cb) {
                // for all objects in animation, increment their top and left 
                // properties by velocities
                //
                // if object is offscreen, remove from animation, set their top 
                // and left properties to the left side of the board, add to 
                // animation deque
                var all_offscreen = true;
                for (var anim_idx = 0; anim_idx < Animation.node_layers_animating.toArray().length; anim_idx++) {
                    var node_layer_in_animation = Animation.node_layers_animating.get(anim_idx);
                    var node_layer_obj = Animation.get_node_layer_obj(node_layer_in_animation.row, node_layer_in_animation.col);
                    var layer_id = node_layer_obj['id'];
                    node_layer_obj['left'] = node_layer_obj['left'] + node_layer_obj['velocity_x'];
                    node_layer_obj['top'] = node_layer_obj['top'] + node_layer_obj['velocity_y'];
                    var node_layer_is_offscreen = Animation.is_node_layer_offscreen(
                        node_layer_obj['top'],
                        node_layer_obj['left'],
                        node_layer_obj['width'],
                        node_layer_obj['height'],
                        Animation.logo_background.width,
                        Animation.logo_background.height
                    );
                    var node_layer_is_about_to_go_off_the_right_edge = Animation.is_node_layer_about_to_go_offscreen_right_edge(
                        node_layer_obj['left'],
                        node_layer_obj['width'],
                        Animation.logo_background.width
                    );
                    if (!node_layer_is_offscreen && !node_layer_is_about_to_go_off_the_right_edge) {
                        d3.select("#" + layer_id)
                            .selectAll('.node_layer_transform')
                            .attr("class", "node_layer_transform update_scroll_right")
                            .attr("velocity_x", node_layer_obj['velocity_x'])
                            .attr("velocity_y", node_layer_obj['velocity_y']);
                        d3.select('#' + layer_id)
                            .transition()
                            .ease(Animation.ANIMATION_EASE_FN)
                            .duration(Animation.ANIMATION_DURATION_MS)
                            .style("left", Animation.num_as_px(node_layer_obj['left']))
                            .style("top", Animation.num_as_px(node_layer_obj['top']));
                        all_offscreen = false;
                    }
                    else if (node_layer_is_about_to_go_off_the_right_edge) {
                        var new_random_svg_node_layer_id = Animation.random_svg_node_layer_obj().id;
                        var current_row_leftmost_obj = Animation.node_layer_current_leftmost_objs[node_layer_in_animation.row];
                        var new_left_edge = current_row_leftmost_obj['left'] - node_layer_obj['width'];
                        d3.select('#' + 'r_' + layer_id)
                            .attr("xlink:href", "#" + new_random_svg_node_layer_id)
                            .style("left", Animation.num_as_px(new_left_edge));
                        node_layer_obj['top'] = node_layer_obj['original_top'];
                        node_layer_obj['left'] = new_left_edge;
                        // reset top, left, and velocity attributes
                        node_layer_obj['velocity_x'] = Animation.node_layer_x_velocity_initial;
                        node_layer_obj['velocity_y'] = Animation.node_layer_y_velocity_initial;
                        Animation.node_layer_current_leftmost_objs[node_layer_in_animation.row] = node_layer_obj;
                        all_offscreen = false;
                    }
                    else {
                    }
                }
                Animation.all_node_layers_offscreen = all_offscreen;
                if (cb) cb();
            };

            Animation.update_scroll_right_zipper = function(verbose, rotate, cb) {
                var all_offscreen = true;
                for (var anim_idx = 0; anim_idx < Animation.node_layers_animating.toArray().length; anim_idx++) {
                    var node_layer_in_animation = Animation.node_layers_animating.get(anim_idx);
                    var node_layer_obj = Animation.get_node_layer_obj(node_layer_in_animation.row, node_layer_in_animation.col);
                    var layer_id = node_layer_obj['id'];
                    node_layer_obj['left'] = node_layer_obj['left'] + node_layer_obj['velocity_x'];
                    node_layer_obj['top'] = node_layer_obj['top'] + node_layer_obj['velocity_y'];
                    if ((node_layer_obj['left'] + node_layer_obj['width']) > (Animation.logo_background.width / 2)) {
                        node_layer_obj['velocity_x'] += node_layer_obj['velocity_x_increment'];
                        if ((node_layer_obj['top'] + (node_layer_obj['height'] / 2)) < (Animation.logo_background.height / 2)) {
                            node_layer_obj['velocity_y'] -= (node_layer_obj['velocity_y_increment'] / 2);
                            if (rotate) node_layer_obj['rotation'] -= node_layer_obj['rotation_increment']; 
                        }
                        else {
                            node_layer_obj['velocity_y'] += (Animation.node_layer_y_velocity_increment / 2);
                            if (rotate) node_layer_obj['rotation'] += node_layer_obj['rotation_increment']; 
                        }    
                    }
                    var node_layer_is_offscreen = Animation.is_node_layer_offscreen(
                        node_layer_obj['top'],
                        node_layer_obj['left'],
                        node_layer_obj['width'],
                        node_layer_obj['height'],
                        Animation.logo_background.width,
                        Animation.logo_background.height
                    );
                    var node_layer_is_about_to_go_off_the_right_edge = Animation.is_node_layer_about_to_go_offscreen_right_edge(
                        node_layer_obj['left'],
                        node_layer_obj['width'],
                        Animation.logo_background.width
                    );
                    if (!node_layer_is_offscreen && !node_layer_is_about_to_go_off_the_right_edge) {
                        if (rotate && ((node_layer_obj['left'] + node_layer_obj['width']) > (Animation.logo_background.width / 2))) {
                            d3.select("#" + layer_id)
                                .transition()
                                .ease(Animation.ANIMATION_EASE_FN)
                                .duration(Animation.ANIMATION_DURATION_MS)
                                .style("left", Animation.num_as_px(node_layer_obj['left']))
                                .style("top", Animation.num_as_px(node_layer_obj['top']))
                                .selectAll('.node_layer_transform')
                                .attr("transform", function(d) { return "rotate(" + node_layer_obj['rotation'] + "," + Animation.NODE_LAYER_CENTER_X + "," + Animation.NODE_LAYER_CENTER_Y + ")"; });
                        }
                        else {
                            d3.select('#' + layer_id)
                                .transition()
                                .ease(Animation.ANIMATION_EASE_FN)
                                .duration(Animation.ANIMATION_DURATION_MS)
                                .style("left", Animation.num_as_px(node_layer_obj['left']))
                                .style("top", Animation.num_as_px(node_layer_obj['top']));
                        }
                        all_offscreen = false;
                    }
                    else if (node_layer_is_about_to_go_off_the_right_edge) {
                        // get the current leftmost object for the row that is animating
                        var new_random_svg_node_layer_id = Animation.random_svg_node_layer_obj().id;
                        var current_row_leftmost_obj = Animation.node_layer_current_leftmost_objs[node_layer_in_animation.row];
                        var new_left_edge = current_row_leftmost_obj['left'] - node_layer_obj['width'];
                        d3.select('#' + 'r_' + layer_id)
                            .attr("xlink:href", "#" + new_random_svg_node_layer_id)
                            .style("left", Animation.num_as_px(new_left_edge));
                        node_layer_obj['top'] = node_layer_obj['original_top'];
                        node_layer_obj['left'] = new_left_edge;
                        // reset top, left, rotation and velocity attributes
                        if (rotate) {
                            node_layer_obj['rotation'] = Animation.node_layer_rotation_initial;
                            d3.select("#" + layer_id)
                                .selectAll('.node_layer_transform')
                                .attr("transform", function(d) { return "rotate(" + node_layer_obj['rotation'] + "," + Animation.NODE_LAYER_CENTER_X + "," + Animation.NODE_LAYER_CENTER_Y + ")"; });
                        }
                        node_layer_obj['velocity_x'] = Animation.node_layer_x_velocity_initial;
                        node_layer_obj['velocity_y'] = Animation.node_layer_y_velocity_initial;
                        node_layer_obj['velocity_x_increment'] = Animation.node_layer_x_velocity_increment;
                        node_layer_obj['velocity_y_increment'] = Animation.node_layer_y_velocity_increment;
                        Animation.node_layer_current_leftmost_objs[node_layer_in_animation.row] = node_layer_obj;
                        all_offscreen = false;
                    }
                    else {
                    }
                }
                Animation.all_node_layers_offscreen = all_offscreen;
                if (cb) cb();
            };

            Animation.set_window_scale = function(scale) {
                var scale = 'scale(' + scale + ')';
                document.body.style.webkitTransform = scale; // Chrome, Opera, Safari
                document.body.style.msTransform = scale;     // IE 9
                document.body.style.transform = scale;       // General
                document.body.style.zoom="100%";
            };

            window.addEventListener("load", function(evt) {
                if (evt.verbose) console.log("window event - load");
                Animation.set_window_scale(1);
                if (Animation.logo_background_img.complete) {
                    Animation.logo_background_img_loaded(false);
                } else {
                    Animation.logo_background_img.addEventListener('load', Animation.logo_background_img_loaded);
                }
            });

            window.addEventListener("resize", function(evt) {
                if (evt.verbose) console.log("window event - resize");
                if (this.resize_window_timer)
                    clearTimeout(this.resize_window_timer);
                this.resize_window_timer = setTimeout(function() {
                    Animation.position_wordmark(evt.verbose, null);
                    Animation.position_content(evt.verbose, null);
                    // Animation.position_node_layers(evt.verbose, null);
                    Animation.reset_node_layers(evt.verbose);
                }, 200);
            });

            document.getElementById("action_reset_node_layers").addEventListener("click", function() { 
                if (document.getElementById("action_pause_animation").firstChild.data == "Play") {
                    document.getElementById("action_pause_animation").firstChild.data = "Pause"
                }
                Animation.reset_node_layers(false);
            });
            
            document.getElementById("action_pause_animation").addEventListener("click", function() { 
                if (!Animation.animation_timer_on_hold) {
                    document.getElementById("action_pause_animation").firstChild.data = "Play";
                    Animation.animation_timer_on_hold = true;
                }
                else {
                    document.getElementById("action_pause_animation").firstChild.data = "Pause";
                    Animation.animation_timer_on_hold = false;
                }
            });

            Animation.load_wordmark_svg = function(verbose, cb) {
                if (verbose) console.log("load_wordmark");
                var wordmark_path = Animation.SVG_ASSET_ROOT + "wordmark.svg";
                d3.xml(wordmark_path, "image/svg+xml", function(error, xml) {
                    if (error) throw error;
                    Animation.update_logo_background_state();
                    xml.documentElement.setAttribute("preserveAspectRatio", "xMidYMid meet");
                    xml.documentElement.setAttribute("class", "svg_content");
                    xml.documentElement.style.width = Animation.num_as_px(0);
                    xml.documentElement.style.top = Animation.num_as_px(-1000);
                    xml.documentElement.style.left = Animation.num_as_px(-1000);
                    xml.documentElement.style.opacity = 0;
                    Animation.wordmark_parent.appendChild(xml.documentElement);
                    if (cb) cb();
                });
            };

            Animation.position_wordmark = function(verbose, cb) {
                if (verbose) console.log("position_wordmark");
                Animation.update_logo_background_state();
                var wordmark = d3.select("#wordmark");
                wordmark.style("width", Animation.num_as_px(Animation.logo_background.width / Animation.WORDMARK_SCALE));
                var top = Animation.num_as_px(Animation.logo_background.centerY - parseInt($('#wordmark').height()) / 2 - parseInt($('#parent_container').css("margin-top")));
                var left = Animation.num_as_px(Animation.logo_background.centerX - parseInt($('#wordmark').width()) / 2);
                wordmark.style("top", top).style("left", left);
                
                if (wordmark.style("opacity") == 0) {
                    wordmark.transition().ease(Animation.WORDMARK_EASE_FN).duration(Animation.WORDMARK_EASE_DURATION_MS).style('opacity', Animation.WORDMARK_FINAL_OPACITY).each("end", function() { if (cb) cb(); });
                }
            };

            Animation.position_content = function(verbose, cb) {
                if (verbose) console.log("position_content");
                Animation.update_logo_background_state();
                $('#content').css("padding-top", Animation.num_as_px(Animation.logo_background.height + Animation.CONTENT_TOP_PADDING));
                if ($('#content').css("opacity") == 0) {
                    d3.select('#content').transition().ease(Animation.CONTENT_EASE_FN).duration(Animation.CONTENT_EASE_DURATION_MS).style('opacity', Animation.CONTENT_FINAL_OPACITY).each("end", function() { if (cb) cb(); });
                }
            };

            Animation.update_logo_background_state = function(verbose, cb) {
                if (verbose) console.log("update_logo_background_state");
                var $this = $('#logo_background');
                Animation.logo_background.offset = $this.offset();
                Animation.logo_background.width = JSON.parse(JSON.stringify($this.width())); // $this.width();
                Animation.logo_background.height = JSON.parse(JSON.stringify($this.height())); // $this.height();
                Animation.logo_background.centerX = Animation.logo_background.offset.left + Animation.logo_background.width / 2;
                Animation.logo_background.centerY = Animation.logo_background.offset.top + Animation.logo_background.height / 2;
                if (cb) cb();
            };

            Animation.logo_background_img_loaded = function(verbose) {
                if (verbose) console.log("logo_background_img_loaded");
                Animation.update_logo_background_state(verbose);
                $('#svg_container').css("height", Animation.num_as_px(logo_background.height));
                Animation.load_wordmark_svg(verbose, function() { 
                    Animation.trigger_window_resize();
                    Animation.load_node_layers_svg(verbose, function() {
                        Animation.init_node_layers(verbose);
                    });
                });
            };

            Animation.load_node_layers_svg = function(verbose, cb) {
                if (verbose) console.log("load_node_layers_svg");
                var node_layers_path = Animation.SVG_ASSET_ROOT + "nodes.svg";
                d3.xml(node_layers_path, "image/svg+xml", function(error, xml) {
                    if (error) throw error;
                    xml.documentElement.style.width = Animation.num_as_px(0);
                    xml.documentElement.style.top = Animation.num_as_px(-1000);
                    xml.documentElement.style.left = Animation.num_as_px(-1000);
                    Animation.node_layers_xml = xml;
                    Animation.node_layers_parent.appendChild(xml.documentElement);
                    if (cb) cb();
                });
            };

            Animation.update_node_layers_state = function(verbose) {
                if (verbose) console.log("update_node_layers_state");
                Animation.update_logo_background_state();
                Animation.node_layers.max_height = (Animation.logo_background.height - (Animation.node_layer_rows * (Animation.node_layer_margin.top + Animation.node_layer_margin.bottom))) / Animation.node_layer_rows;
                Animation.node_layers.max_width = Animation.node_layers.max_height;
                Animation.node_layers.rows = parseInt(Animation.node_layer_rows) + 1;
                
                // use the following column count when the x velocity increment is 0, 
                // to generate a full field of elements. 

                // Animation.node_layers.cols = parseInt(Math.ceil((1 / Animation.NODE_COL_SQUEEZE_FACTOR) * Math.ceil(Animation.logo_background.width / Animation.node_layers.max_width))) + 1;

                // otherwise, to help improve performance we reduce the number of 
                // elements by reducing the number of columns to only those needed 
                // for viewing onscreen

                Animation.node_layers.cols = parseInt(Math.ceil((1 / Animation.NODE_COL_SQUEEZE_FACTOR) * Math.ceil((3 * Animation.logo_background.width / 5) / Animation.node_layers.max_width))) + 4;
            };

            Animation.init_node_layers = function(verbose, cb) {
                if (verbose) console.log("init_node_layers");
                Animation.update_node_layers_state(verbose);
                $('#node_layers_container').height(Animation.logo_background.height);
                $('#node_layers_container').css("opacity", 0);
                for (var row_idx = 0; row_idx < Animation.node_layers.rows; row_idx++) {
                    var node_layer_row = new Deque();
                    for (var col_idx = 0; col_idx < Animation.node_layers.cols; col_idx++) {
                        var random_svg_node_layer_id = Animation.random_svg_node_layer_obj().id;
                        var col_shift = Animation.node_layers.max_height / 2; 
                        var row_shift = (row_idx % 2) ? -5*Animation.node_layers.max_width / 2 : -3*Animation.node_layers.max_width;
                        // build a data model for the offset and size of each node layer
                        var node_layer_obj = {};
                        node_layer_obj['id'] = 'node-layer-' + Math.guid(); // CSS selectors cannot start with digits cf. http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier
                        node_layer_obj['node_id'] = random_svg_node_layer_id;
                        node_layer_obj['static'] = true;
                        node_layer_obj['rotation'] = Animation.node_layer_rotation_initial;
                        node_layer_obj['rotation_increment'] = Animation.node_layer_rotation_increment;
                        node_layer_obj['velocity_x'] = Animation.node_layer_x_velocity_initial;
                        node_layer_obj['velocity_x_increment'] = Animation.node_layer_x_velocity_increment;
                        node_layer_obj['velocity_y'] = Animation.node_layer_y_velocity_initial;
                        node_layer_obj['velocity_y_increment'] = Animation.node_layer_y_velocity_increment;
                        node_layer_obj['top'] = (row_idx * (Animation.node_layers.max_height + Animation.node_layer_margin.top + Animation.node_layer_margin.bottom) - col_shift) * Animation.NODE_ROW_SQUEEZE_FACTOR;
                        node_layer_obj['left'] = col_idx * Animation.NODE_COL_SQUEEZE_FACTOR * (Animation.node_layers.max_width + Animation.node_layer_margin.left + Animation.node_layer_margin.right) + row_shift - Animation.logo_background.width/2;
                        node_layer_obj['width'] = Animation.node_layers.max_width + Animation.node_layer_margin.left + Animation.node_layer_margin.right;
                        node_layer_obj['height'] = Animation.node_layers.max_height + Animation.node_layer_margin.top + Animation.node_layer_margin.bottom;
                        node_layer_obj['original_top'] = node_layer_obj['top'];
                        node_layer_obj['original_left'] = node_layer_obj['left'];
                        node_layer_row.push(node_layer_obj);
                        // render UI element from data model
                        var layer_id = node_layer_obj['id'];
                        var layer_classes = "node_layer_container nlrow_" + row_idx + " nlcol_" + col_idx;
                        d3.select("#node_layers_container")
                            .append("svg")
                            .attr("id", layer_id)
                            .attr("class", layer_classes)
                            .attr("width", node_layer_obj['width'])
                            .attr("height", node_layer_obj['height'])
                            .attr("viewBox", "0 0 216 216")
                            .append("g")
                            .attr("class", "node_layer_transform")
                            .attr("transform", "translate(" + Animation.node_layer_margin.left + "," + Animation.node_layer_margin.top + ")")
                            .append("use")
                            .attr("id", "r_" + layer_id)
                            .attr("class", "random_node_layer" + (col_idx % 2 ? " random_node_layer_even" : " random_node_layer_odd"))
                            .attr("xlink:href", "#" + random_svg_node_layer_id);
                        $('#' + layer_id).css("top", Animation.num_as_px(node_layer_obj['top']));
                        $('#' + layer_id).css("left", Animation.num_as_px(node_layer_obj['left']));
                        $('#' + layer_id).css("width", Animation.num_as_px(node_layer_obj['width'] * Animation.NODE_LAYER_SCALE));
                        $('#' + layer_id).css("height", Animation.num_as_px(node_layer_obj['height'] * Animation.NODE_LAYER_SCALE));
                        if (col_idx == 0) {
                            Animation.node_layer_current_leftmost_objs[row_idx] = node_layer_obj;
                        }
                        Animation.node_layers_ids.push(layer_id);
                    }
                    Animation.node_layers_deque.push(node_layer_row);
                }
                d3.select('#node_layers_container')
                    .transition()
                    .ease(Animation.NODE_LAYERS_EASE_FN)
                    .duration(Animation.NODE_LAYERS_EASE_DURATION_MS)
                    .style('opacity', Animation.NODE_LAYERS_FINAL_OPACITY)
                    .each("end", function() { 
                        Animation.node_layers_all_visible = true; 
                        Animation.node_layers_loaded = true;
                        if (cb) cb();
                    });
            };

            Animation.position_node_layers = function(verbose, cb) {
                if (verbose) console.log("position_node_layers");
                Animation.update_node_layers_state();
                Animation.update_logo_background_state(false, function() {
                    $('#node_layers_container').height(Animation.logo_background.height);
                    $('#svg_container').css("height", Animation.num_as_px(Animation.logo_background.height));
                });
                for (var row_idx = 0; row_idx < Animation.node_layers.rows; row_idx++) {
                    var node_layer_row = Animation.node_layers_deque.get(row_idx);
                    for (var col_idx = 0; col_idx < Animation.node_layers.cols; col_idx++) {
                        try {
                            var node_layer_obj = node_layer_row.get(col_idx);
                            var layer_id = node_layer_obj['id'];
                            var col_shift = Animation.node_layers.max_height / 2; 
                            var row_shift = (row_idx % 2) ? -5*Animation.node_layers.max_width / 2 : -3*Animation.node_layers.max_width;
                            /* calculate per-node layer model values */
                            node_layer_obj['top'] = (row_idx * (Animation.node_layers.max_height + Animation.node_layer_margin.top + Animation.node_layer_margin.bottom) - col_shift) * Animation.NODE_ROW_SQUEEZE_FACTOR;
                            node_layer_obj['left'] = col_idx * Animation.NODE_COL_SQUEEZE_FACTOR * (Animation.node_layers.max_width + Animation.node_layer_margin.left + Animation.node_layer_margin.right) + row_shift - Animation.logo_background.width/2;
                            node_layer_obj['width'] = Animation.node_layers.max_width + Animation.node_layer_margin.left + Animation.node_layer_margin.right;
                            node_layer_obj['height'] = Animation.node_layers.max_height + Animation.node_layer_margin.top + Animation.node_layer_margin.bottom;
                            node_layer_obj['original_top'] = node_layer_obj['top'];
                            node_layer_obj['original_left'] = node_layer_obj['left'];
                            /* update UI */
                            $('#' + layer_id).css("width", Animation.num_as_px(node_layer_obj['width'] * Animation.NODE_LAYER_SCALE));
                            $('#' + layer_id).css("height", Animation.num_as_px(node_layer_obj['height'] * Animation.NODE_LAYER_SCALE));
                            d3.select('#' + layer_id)
                                .transition()
                                .ease("linear")
                                .duration(0)
                                .style("top", Animation.num_as_px(node_layer_obj['top']))
                                .style("left", Animation.num_as_px(node_layer_obj['left']));
                        }
                        catch (err) {
                            console.log("Animation.position_node_layers failed at:", row_idx, col_idx, err);
                        } 
                    }
                }
                if (cb) cb();
            };

            Animation.reset_node_layers = function(verbose) {
                if (verbose) console.log("reset_node_layers");
                Animation.animation_timer_on_hold = true;
                Animation.animation_is_setup = false;
                if (document.getElementById("action_pause_animation").firstChild.data == "Play") {
                    document.getElementById("action_pause_animation").firstChild.data = "Pause"
                }
                Animation.all_node_layers_offscreen = true;
                Animation.node_layer_initial_column_lefts = [];
                Animation.node_layers_loaded = false;
                Animation.node_layers_animating.clear();
                while (!Animation.node_layers_animating.isEmpty()) {
                    Animation.node_layers_animating.pop();
                }
                Animation.node_layers_deque.clear();
                while (!Animation.node_layers_deque.isEmpty()) {
                    Animation.node_layers_deque.pop();
                }
                var nl_parent = document.getElementById('node_layers_container');
                while (nl_parent.hasChildNodes()) {
                    nl_parent.removeChild(nl_parent.lastChild);
                }
                Animation.load_node_layers_svg(verbose, function() {
                    Animation.init_node_layers(verbose, function() { 
                        Animation.position_node_layers(verbose, function() {
                            Animation.animation_timer_on_hold = false;
                        }); 
                    });
                });
            };

            Animation.random_svg_node_layer_obj = function() {
                var idx = Math.ceil(Math.random() * Animation.NODE_LAYERS);
                return { 
                    'id' : Animation.NODE_LAYER_ID_PREFIX + idx, 
                    'idx' : idx 
                }; 
            };

            Animation.is_node_layer_offscreen = function(obj_top, obj_left, obj_width, obj_height, parent_width, parent_height) {
                return (
                    (obj_top < -2*obj_height) || 
                    (obj_top > parent_height + obj_height) || 
                    (obj_left > parent_width + obj_width)
                );
            };

            Animation.is_node_layer_about_to_go_offscreen_right_edge = function(obj_left, obj_width, parent_width) {
                //return (obj_left > (parent_width - obj_width));
                return (obj_left > parent_width);
            };

            Animation.num_as_px = function(i) {
                return parseFloat(i) + "px";
            };

            Animation.get_node_layer_obj = function(row, col) {
                return Animation.node_layers_deque.get(row).get(col);
            };

            Animation.get_random_int_inclusive = function(min, max) {
                return Math.floor(Math.random() * (max - min + 1) + min);
            };

            function get_random_float_exclusive(min, max) {
                return Math.random() * (max - min) + min;
            };

            Animation.trigger_window_resize = function(verbose) {
                if (verbose) console.log("trigger_window_resize");
                window.dispatchEvent(new Event('resize'));
            };

        </script>
    </body>
    
</html>
